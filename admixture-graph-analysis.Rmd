---
title: "Admixture graph analysis"
author: "Thomas Mailund"
date: "12 Aug 2015"
output: html_document
---

```{r setup, include=FALSE}

suppressPackageStartupMessages(library(dplyr, quietly = TRUE))
suppressPackageStartupMessages(library(magrittr, quietly = TRUE))
suppressPackageStartupMessages(library(neldermead, quietly = TRUE))
suppressPackageStartupMessages(library(ggplot2, quietly = TRUE))
suppressPackageStartupMessages(library(ggthemes, quietly = TRUE))
suppressPackageStartupMessages(library(stringr, quietly = TRUE))
suppressPackageStartupMessages(library(reshape2, quietly = TRUE))
suppressPackageStartupMessages(library(knitr, quietly = TRUE))
suppressPackageStartupMessages(library(gridExtra, quietly = TRUE))

opts_chunk$set(dev = 'pdf')

#library(devtools)
#install_github("mailund/admixture_graph")
library(admixturegraph)

## Data handling
getPopulation <- Vectorize(function(name) {
  if (name %in% c("popAnu2", "rheMac2")) {
    name
  } else {
    paste(unlist(str_split(name, '\\.'))[1:2], collapse='.')
  }
})

f4 <- tbl_df(read.table('admixtools-results//intersection-A-f4-individuals-results.txt',
                        header=TRUE, stringsAsFactors = FALSE)) %>%
  filter(X != "rheMac2", Y != "rheMac2", Z != "rheMac2",
         X != "papAnu2", Y != "papAnu2", Z != "papAnu2") %>%
  project_to_population(getPopulation) %>%
  filter(X != Y, X != Z, Y != Z)

f4 %<>% mutate(test = paste("D(", W, ",", X, ";", Y, ",", Z, ")", sep=""))
f4 %<>% filter(.X_ind != "P.anubis.L142", .Y_ind != "P.anubis.L142", .Z_ind != "P.anubis.L142")

posf4 <- filter(f4, D >= 0)
```

```{r data_plotting_code, echo=FALSE}
f4data <- function(x) {
  class(x) <- c("f4data", class(x))
  x
}

plot.f4data <- function(x, sigma = 5, ...) {
  
  # I know this is not the 'dplyr' way of doing it, but package check doesn't like
  # non standard evaluation, so this is what is needed.
  fit <- x
  fit$stderr <- with(fit, D / Z.value)
  fit$error_bar_start <- with(fit, D - sigma/2*stderr)
  fit$error_bar_end   <- with(fit, D + sigma/2*stderr)
  fit$test <- with(fit, paste("D(",W,",",X,";",Y,",",Z,")"))
  fit$test <- factor(fit$test, levels=arrange(fit, D)$test)
  
  ggplot(fit) +
    geom_hline(yintersect = 0, linetype = 'dashed', color = 'gray') +
    geom_errorbar(aes_string(x = 'test', ymin = 'error_bar_start', ymax = 'error_bar_end'), color='black') +
    geom_point(aes_string(x = 'test', y = 'D'), color='black') +
    xlab('') + ylab('') + 
    coord_flip() +
    theme_classic() +
    theme(legend.position="none") +
    theme(axis.text.y = element_text(size = 4)) +
    theme(axis.line = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks = element_blank()) +
    theme(panel.grid.major = element_line(color = 'white'),
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_line(color = '#eeeeee'))
}

```

```{r poor_fit_func, echo=FALSE}
poor_fit <- function(fit, sigma) fitted(fit) %>% mutate(stderr = D/Z.value) %>% filter(abs(D-graph_f4) > sigma/2*stderr)
n_poor_fit <- function(fit, sigma) nrow(poor_fit(fit, sigma))
```

```{r optimisation_setup, echo=FALSE}
optopts <- optimset(Display='iter')
```

FIXME: Introduction to admixture graphs


# Fitting trees

Statistics D(rheMac2,X;Y,Z) are expected to be zero if X is an outgroup to the pair Y and Z. We can compute the number of tests that are compatible with a tree topology, $k$, out of the number of tests, $n$ for all triplets of species and obtain the values:

```{r, echo=FALSE}
outgroup_support_count <- function(f4, O, I1, I2) {
  f4 %>% filter(X == O, Y == I1, Z == I2) %>%
    summarise(n = n(), k = sum(abs(Z.value) < 3))
}

species <- unique(f4$X)
outgroup_tests <- data.frame()
for (O in species) {
  for (I1 in species) {
    for (I2 in species) {
      if (O != I1 && O != I2 && I1 < I2)
        outgroup_tests <- rbind(outgroup_tests, cbind(data.frame(X = O, Y = I1, Z = I2), outgroup_support_count(f4, O, I1, I2)))
    }
  }
}

outgroup_tests %>% kable
```

Most of these triplets are strongly against the (X,(Y,Z)) topology ($k$ is zero); a few have a small fraction of the tests compatible with the topology, and the following have all tests compatible with the topology ($n=k$):
```{r, echo=FALSE}
outgroup_tests %>% filter(n == k) %>% kable
```

Three of these group P. hamadryas and P. papio (with P. cynocephalus, kindae and ursinus as outgroup, respectively) and one groups P. cynocephalus with P. ursinus with P. papio as outgroup. All other triplets are not compatible with a simple tree.

# Expanding to quartets

We can consider the quartet P. cynocephalus, hamadryas, papio and kindea. From the tree tests we know that both P. cynoceplahus and P. kindae are outgroups compared to hamadryas and papio, but all four cannot be combined to a single tree: the topology (P.cynocephalus,(P.kindae,(P.hamadryas,P.papio))) would then have P. cynocephalus as an outgroup to P. kindae and P. hamadryas and P. kindae and P. papio which the statistics do not support; symmetric arguments rules out (P.kindae,(P.cynocephalus,(P.hamadryas,P.papio))); and for ((P.kindae,P.cynocephalus),(P.hamadryas,P.papio)) we should have both P.hamadrays and P.papio as outgroups to (P.kindae,P.cynocephalus) which we also do not see.

Even though neither of these three tree topologies will fit the data we can still determine which is closest to fitting the data and then attempt to fit the data by adding additional gene flow.

The first tree topology is:

```{r (c(k(hp))), echo=FALSE}
leaves <- c("rheMac2", "P.cynocephalus", "P.kindae", "P.hamadryas", "P.papio")
inner_nodes <- c("R", "x", "y", "z")

edges <- parent_edges(c(edge("rheMac2", "R"),
                        edge("x", "R"),
                        edge("P.cynocephalus", "x"),
                        edge("y", "x"),
                        edge("P.kindae", "y"),
                        edge("z", "y"),
                        edge("P.hamadryas", "z"),
                        edge("P.papio", "z")
                        ))
admixtures <- NULL

c_k_hp_tree <- agraph(leaves, inner_nodes, edges, admixtures)
plot(c_k_hp_tree)
```

Which fits the data as illustrated on the plot below where the black error bars are the observed statistics and the red and green dots are the statistics predicted by the best fitted tree (red dots illustrates that the predictions fall outside of the error bars and green dots that they fall within the error bars).

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(c_k_hp_tree) %>% fit_graph(c_k_hp_tree) -> fit_c_k_hp_tree
fit_c_k_hp_tree %>% split_population %>% plot(sigma=6)
```

The second tree is:

```{r (k(c(hp))), echo=FALSE}
leaves <- c("rheMac2", "P.kindae", "P.cynocephalus", "P.hamadryas", "P.papio")
inner_nodes <- c("R", "x", "y", "z")

edges <- parent_edges(c(edge("rheMac2", "R"),
                        edge("x", "R"),
                        edge("P.kindae", "x"),
                        edge("y", "x"),
                        edge("P.cynocephalus", "y"),
                        edge("z", "y"),
                        edge("P.hamadryas", "z"),
                        edge("P.papio", "z")
                        ))
admixtures <- NULL

k_c_hp_tree <- agraph(leaves, inner_nodes, edges, admixtures)
plot(k_c_hp_tree)
```

With fit:

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(k_c_hp_tree) %>% fit_graph(k_c_hp_tree) -> fit_k_c_hp_tree
fit_k_c_hp_tree %>% split_population %>% plot(sigma=6)
```

And the third tree is:

```{r ((kc)(hp)), echo=FALSE}
leaves <- c("rheMac2", "P.kindae", "P.cynocephalus", "P.hamadryas", "P.papio")
inner_nodes <- c("R", "x", "y", "z")

edges <- parent_edges(c(edge("rheMac2", "R"),
                        edge("x", "R"),
                        edge("y", "x"),
                        edge("z", "x"),
                        edge("P.kindae", "y"),
                        edge("P.cynocephalus", "y"),
                        edge("P.hamadryas", "z"),
                        edge("P.papio", "z")
                        ))
admixtures <- NULL

kc_hp_tree <- agraph(leaves, inner_nodes, edges, admixtures)
plot(kc_hp_tree)
```

With fit:

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(kc_hp_tree) %>% fit_graph(kc_hp_tree) -> fit_kc_hp_tree
fit_kc_hp_tree %>% split_population %>% plot(sigma=6)
```

The sum of squared errors (SSE) of these trees (the sum of squared distances from the observed statistics to the expectations given by the trees) are `r round(fit_c_k_hp_tree$error, 3)`, `r round(fit_k_c_hp_tree$error, 3)`, and `r round(fit_kc_hp_tree$error, 3)`, respectively, where the third fits the data substantially better, as is also apparent from the plots of the fits.

## Adding admixture

One thing we can observe from the statistics is that D(rheMac2,P.papio;P.cynocephalus,P.kindae) and D(rheMac2,P.hamadryas;P.cynocephalus,P.kindae) statistics are positive while the tree expects them to be zero. This suggests gene flow between P.kindae and the P.hamadryas/P.papio clade. There are two graphs with such gene flow, differing only in the direction of gene flow:

```{r kindae_admixed, echo=FALSE}
leaves <- c("rheMac2", "P.cynocephalus", "P.kindae", "P.hamadryas", "P.papio")
inner_nodes <- c("R", "x", "y", "z", "w", "anc.kindae")

edges <- parent_edges(c(
  edge("rheMac2", "R"),
  edge("x", "R"),
  edge("y", "x"), 
  edge("z", "w"),edge("w", "x"),
  edge("P.kindae", "anc.kindae"), admixture_edge("anc.kindae", "y", "w"),
  edge("P.cynocephalus", "y"),
  edge("P.hamadryas", "z"),
  edge("P.papio", "z")
))
admixtures <- admixture_proportions(c(
  admix_props("anc.kindae", "y", "w", "a")
))

kindae_admixed_graph <- agraph(leaves, inner_nodes, edges, admixtures)
plot(kindae_admixed_graph, show_admixture_labels = TRUE)
```

```{r hp_admixed, echo=FALSE}
leaves <- c("rheMac2", "P.cynocephalus", "P.kindae", "P.hamadryas", "P.papio")
inner_nodes <- c("R","anc.kindae", "x", "y", "w", "z")

edges <- parent_edges(c(
  edge("rheMac2", "R"),
  edge("x", "R"),
  edge("y", "x"), 
  edge("z", "w"), admixture_edge("w", "anc.kindae", "x"),
  edge("P.kindae", "anc.kindae"), edge("anc.kindae", "y"),
  edge("P.cynocephalus", "y"),
  edge("P.hamadryas", "z"),
  edge("P.papio", "z")
))
admixtures <- admixture_proportions(c(
  admix_props("w", "anc.kindae", "x", "a")
))

hp_admixed_graph <- agraph(leaves, inner_nodes, edges, admixtures)
plot(hp_admixed_graph, show_admixture_labels = TRUE)
```

These graphs have identical fit:

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(kindae_admixed_graph) %>% fit_graph(kindae_admixed_graph) -> fit_kindae_admixed_graph
fit_kindae_admixed_graph %>% split_population %>% plot(sigma=6)
```

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(hp_admixed_graph) %>% fit_graph(hp_admixed_graph) -> fit_hp_admixed_graph
fit_hp_admixed_graph %>% split_population %>% plot(sigma=6)
```



## Adding P. ursinus

The tree topology tests told us that P. cynocephalus clusters with P. ursinus with P. papio as an outgroup but not with P. kindae or P. hamadryas which gives us a limited set of edges where we can place this species.

```{r kindae_admixed_u1, echo=FALSE}
leaves <- c("rheMac2", "P.cynocephalus", "P.ursinus", "P.kindae", "P.hamadryas", "P.papio")
inner_nodes <- c("R", "x", "y", "z", "w", "anc.kindae", "anc.ursinus")

edges <- parent_edges(c(
  edge("rheMac2", "R"),
  edge("x", "R"),
  edge("y", "x"), 
  edge("z", "w"),edge("w", "x"),
  edge("P.kindae", "anc.kindae"), admixture_edge("anc.kindae", "y", "w"),
  edge("P.cynocephalus", "anc.ursinus"), edge("anc.ursinus", "y"),
  edge("P.ursinus", "anc.ursinus"),
  edge("P.hamadryas", "z"),
  edge("P.papio", "z")
))
admixtures <- admixture_proportions(c(
  admix_props("anc.kindae", "y", "w", "a")
))

kindae_admixed_graph_u1 <- agraph(leaves, inner_nodes, edges, admixtures)
plot(kindae_admixed_graph_u1, show_admixture_labels = TRUE, main = "Kindae admixed 1")
```

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(kindae_admixed_graph_u1) %>% fit_graph(kindae_admixed_graph_u1) -> fit_kindae_admixed_graph_u1
#fit_kindae_admixed_graph_u1 %>% split_population %>% plot(sigma=6)
```

```{r kindae_admixed_u2, echo=FALSE}
leaves <- c("rheMac2", "P.ursinus", "P.cynocephalus", "P.kindae", "P.hamadryas", "P.papio")
inner_nodes <- c("R", "x", "y", "z", "w", "anc.kindae", "anc.ursinus")

edges <- parent_edges(c(
  edge("rheMac2", "R"),
  edge("x", "R"),
  edge("y", "anc.ursinus"), edge("anc.ursinus", "x"),
  edge("z", "w"),edge("w", "x"),
  edge("P.kindae", "anc.kindae"), admixture_edge("anc.kindae", "y", "w"),
  edge("P.cynocephalus", "y"), 
  edge("P.ursinus", "anc.ursinus"),
  edge("P.hamadryas", "z"),
  edge("P.papio", "z")
))
admixtures <- admixture_proportions(c(
  admix_props("anc.kindae", "y", "w", "a")
))

kindae_admixed_graph_u2 <- agraph(leaves, inner_nodes, edges, admixtures)
plot(kindae_admixed_graph_u2, show_admixture_labels = TRUE, main = "Kindae admixed 2")
```

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(kindae_admixed_graph_u2) %>% fit_graph(kindae_admixed_graph_u2) -> fit_kindae_admixed_graph_u2
#fit_kindae_admixed_graph_u2 %>% split_population %>% plot(sigma=6)
```

```{r kindae_admixed_u3, echo=FALSE}
leaves <- c("rheMac2","P.cynocephalus",  "P.ursinus", "P.kindae", "P.hamadryas", "P.papio")
inner_nodes <- c("R", "x", "y", "z", "w", "anc.kindae", "anc.ursinus")

edges <- parent_edges(c(
  edge("rheMac2", "R"),
  edge("x", "R"),
  edge("y", "x"),
  edge("z", "w"),edge("w", "x"),
  edge("P.kindae", "anc.kindae"), 
  admixture_edge("anc.kindae", "anc.ursinus", "w"), edge("anc.ursinus", "y"),
  edge("P.cynocephalus", "y"), 
  edge("P.ursinus", "anc.ursinus"), 
  edge("P.hamadryas", "z"),
  edge("P.papio", "z")
))
admixtures <- admixture_proportions(c(
  admix_props("anc.kindae", "anc.ursinus", "w", "a")
))

kindae_admixed_graph_u3 <- agraph(leaves, inner_nodes, edges, admixtures)
plot(kindae_admixed_graph_u3, show_admixture_labels = TRUE, main = "Kindae admixed 3")
```

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(kindae_admixed_graph_u3) %>% fit_graph(kindae_admixed_graph_u3) -> fit_kindae_admixed_graph_u3
#fit_kindae_admixed_graph_u3 %>% split_population %>% plot(sigma=6)
```

```{r hp_admixed_u, echo=FALSE}
leaves <- c("rheMac2", "P.cynocephalus", "P.ursinus", "P.kindae", "P.hamadryas", "P.papio")
inner_nodes <- c("R","anc.kindae", "x", "y", "w", "z", "anc.ursinus")

edges <- parent_edges(c(
  edge("rheMac2", "R"),
  edge("x", "R"),
  edge("y", "x"), 
  edge("z", "w"), admixture_edge("w", "anc.kindae", "x"),
  edge("P.kindae", "anc.kindae"), edge("anc.kindae", "y"),
  edge("P.cynocephalus", "anc.ursinus"), edge("anc.ursinus", "y"),
  edge("P.ursinus", "anc.ursinus"),
  edge("P.hamadryas", "z"),
  edge("P.papio", "z")
))
admixtures <- admixture_proportions(c(
  admix_props("w", "anc.kindae", "x", "a")
))

hp_admixed_graph_u <- agraph(leaves, inner_nodes, edges, admixtures)
plot(hp_admixed_graph_u, show_admixture_labels = TRUE, main = "Hamdryas/papio admixed")
```

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(hp_admixed_graph_u) %>% fit_graph(hp_admixed_graph_u) -> fit_hp_admixed_graph_u
#fit_hp_admixed_graph_u %>% split_population %>% plot(sigma=6)
```

 Graph                 |  SSE                                             | # Tests not fitting (with $6\sigma$ error bars)
:----------------------|-------------------------------------------------:|-------------------------------------------------------:
Kindae admixed 1       | `r round(fit_kindae_admixed_graph_u1$error, 3)`  | `r n_poor_fit(fit_kindae_admixed_graph_u1, sigma=6)`
Kindae admixed 2       | `r round(fit_kindae_admixed_graph_u2$error, 3)`  | `r n_poor_fit(fit_kindae_admixed_graph_u2, sigma=6)`
Kindae admixed 3       | `r round(fit_kindae_admixed_graph_u3$error, 3)`  | `r n_poor_fit(fit_kindae_admixed_graph_u3, sigma=6)`
Hamdryas/papio admixed | `r round(fit_hp_admixed_graph_u$error, 3)`       | `r n_poor_fit(fit_hp_admixed_graph_u, sigma=6)`

The clear winner is graph number three with the following fit:

```{r, echo=FALSE, fig.height=25}
fit_kindae_admixed_graph_u3 %>% split_population %>% plot(sigma=6)
```

The remaining poor fits are:
```{r, echo=FALSE}
poor_fit(fit_kindae_admixed_graph_u3, sigma=6) %>% split_population %>% select(X,Y,Z,D,graph_f4) %>% arrange(desc(D-graph_f4)) %>% kable
```


## Adding P. anubis

For P. anubis we do not have support for it being an outgroup of any of the species pairs but it is much closer to being it (D statistics much closer to zero) for P.cynocephalus / P.ursinus, P.cynocephalus / P.kindae, and P.ursinus / P.kindae than for any other comparison. Between P.hamadryas and P.papio it is closer to P.papio.

```{r, echo=FALSE, fig.height=15, fig.width=15}
poplabel_order <- paste("D(rheMac2,X;", 
                        c(rep("P.cynocephalus", 4), rep("P.ursinus", 3), rep("P.kindae", 2), "P.hamadryas"),
                        ",", 
                        c("P.ursinus", "P.kindae", "P.hamadryas", "P.papio", 
                          "P.kindae", "P.hamadryas", "P.papio",
                          "P.hamadryas", "P.papio",
                          "P.papio"
                          ),
                        ")", sep='')

Xanubis <- f4 %>%
  filter(X == "P.anubis") %>% 
  mutate(poplabel = factor(paste("D(rheMac2,X;", Y, ",", Z, ")", sep=''), levels = poplabel_order)) %>%
  filter(!is.na(poplabel))
  
split_pops <- function(x)
  x %>%
  split_population %>%
  mutate(label = paste("D(rheMac2,X;", Y, ",", Z, ")", sep='')) %>%
  mutate(stderr = D / Z.value)

sigma <- 6
plot_anubis <- function(data)
  ggplot(data = data) +
  xlab("") + ylab("") +
  geom_vline(xintersect = 0, linetype = 'dashed', color = 'gray') +
  geom_errorbarh(aes(y = label, x = D, xmin = D - sigma/2 * stderr, xmax = D + sigma/2 * stderr), color='black') +
  #geom_point(aes(x=D, y=label)) +
  facet_grid(poplabel~X, scales="free_y", space = "free_y") +
  theme_classic() +
    theme(legend.position="none") +
    theme(axis.line = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks = element_blank()) +
  theme(strip.text.y = element_text(angle = 0)) +
    theme(panel.grid.major = element_line(color = 'white'),
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_line(color = '#eeeeee'))

Xanubis %>% #filter(Y == "P.cynocephalus", Z == "P.kindae") %>% 
  split_pops %>% plot_anubis
```

Unadmixed we would therefore put P. anubis as a sister group to P.papio.

```{r kindae_admixed_u3_anubis_papio, echo=FALSE}
leaves <- c("rheMac2","P.cynocephalus",  "P.ursinus", "P.kindae", "P.hamadryas", "P.papio", "P.anubis")
inner_nodes <- c("R", "x", "y", "z", "w", "anc.kindae", "anc.ursinus", "anc.papio")

edges <- parent_edges(c(
  edge("rheMac2", "R"),
  edge("x", "R"),
  edge("y", "x"),
  edge("z", "w"),edge("w", "x"),
  edge("P.kindae", "anc.kindae"), 
  admixture_edge("anc.kindae", "anc.ursinus", "w"), edge("anc.ursinus", "y"),
  edge("P.cynocephalus", "y"), 
  edge("P.ursinus", "anc.ursinus"), 
  edge("P.hamadryas", "z"),
  edge("P.papio", "anc.papio"), edge("anc.papio", "z"),
  edge("P.anubis", "anc.papio")
))
admixtures <- admixture_proportions(c(
  admix_props("anc.kindae", "anc.ursinus", "w", "a")
))

kindae_admixed_graph_u3_anubis_papio <- agraph(leaves, inner_nodes, edges, admixtures)
plot(kindae_admixed_graph_u3_anubis_papio, show_admixture_labels = TRUE, main = "Unadmixed anubis")
```

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(kindae_admixed_graph_u3_anubis_papio) %>% fit_graph(kindae_admixed_graph_u3_anubis_papio) -> fit_kindae_admixed_graph_u3_anubis_papio
```

The fit, however, is rather poor with a SSE of `r round(fit_kindae_admixed_graph_u3_anubis_papio$error, 3)` and `r n_poor_fit(fit_kindae_admixed_graph_u3_anubis_papio, 6)` expectations not fitting the observed statistics.

```{r, echo=FALSE, fig.height=25}
fit_kindae_admixed_graph_u3_anubis_papio %>% split_population %>% plot(sigma=6)
```

The observed D statistics indicated that P. hamadryas is not an outgroup of P. anubis and P. papio but rather that P. anubis is admixed between the two.

```{r kindae_admixed_u3_anubis_papio_hamadryas, echo=FALSE}
leaves <- c("rheMac2","P.cynocephalus",  "P.ursinus", "P.kindae", "P.hamadryas", "P.anubis", "P.papio")
inner_nodes <- c("R", "x", "y", "z", "w", "anc.kindae", "anc.ursinus", "anc.hamadryas", "anc.anubis", "anc.papio")

edges <- parent_edges(c(
  edge("rheMac2", "R"),
  edge("x", "R"),
  edge("y", "x"),
  edge("z", "w"),edge("w", "x"),
  edge("P.kindae", "anc.kindae"), 
  admixture_edge("anc.kindae", "anc.ursinus", "w"), edge("anc.ursinus", "y"),
  edge("P.cynocephalus", "y"), 
  edge("P.ursinus", "anc.ursinus"), 
  edge("P.hamadryas", "anc.hamadryas"), edge("anc.hamadryas", "z"),
  edge("P.papio", "anc.papio"), edge("anc.papio", "z"),
  edge("P.anubis", "anc.anubis"),
  admixture_edge("anc.anubis", "anc.hamadryas", "anc.papio")
))
admixtures <- admixture_proportions(c(
  admix_props("anc.kindae", "anc.ursinus", "w", "a"),
  admix_props("anc.anubis", "anc.hamadryas", "anc.papio", "b")
))

kindae_admixed_graph_u3_anubis_papio_hamadryas <- agraph(leaves, inner_nodes, edges, admixtures)
plot(kindae_admixed_graph_u3_anubis_papio_hamadryas, show_admixture_labels = TRUE, main = "Hamadryas / papio admixed anubis")
```

```{r, echo=FALSE, fig.height=20}
options <- optimset(TolFun=1e-6)
posf4 %>% filter_on_leaves(kindae_admixed_graph_u3_anubis_papio_hamadryas) %>%
  fit_graph(kindae_admixed_graph_u3_anubis_papio_hamadryas, options) -> fit_kindae_admixed_graph_u3_anubis_papio_hamadryas
```

Making P. anubis admixed we get an SSE of `r round(fit_kindae_admixed_graph_u3_anubis_papio_hamadryas$error, 3)` and `r n_poor_fit(fit_kindae_admixed_graph_u3_anubis_papio_hamadryas, 6)` expectations not fitting the observed statistics. This is an improvement in SSE but not the number of fitting tests.

```{r, echo=FALSE, fig.height=25}
fit_kindae_admixed_graph_u3_anubis_papio_hamadryas %>% split_population %>% plot(sigma=6)
```

In the tests not fitting there is some evidence of gene flow between P. anubis and P. cynocephalus. We can fit such a gene flow in several different topologis depending on the order of admixtures above P. anubis but the end result will be a three-way mix for P. anubis and the results would be indistinguishable so we only consider the topology below:

```{r kindae_admixed_u3_anubis_papio_hamadryas_cynocephalus_1, echo=FALSE}
leaves <- c("rheMac2","P.ursinus", "P.kindae", "P.cynocephalus",  "P.hamadryas", "P.anubis", "P.papio")
inner_nodes <- c("R", "x", "y", "z", "w", "anc.kindae", "anc.ursinus", "anc.hamadryas", "anc.anubis1", "anc.anubis2", "anc.papio",
                 "anc.cynocephalus")

edges <- parent_edges(c(
  edge("rheMac2", "R"),
  edge("x", "R"),
  edge("y", "x"),
  edge("z", "w"),edge("w", "x"),
  edge("P.kindae", "anc.kindae"), 
  admixture_edge("anc.kindae", "anc.ursinus", "w"), edge("anc.ursinus", "y"),
  edge("P.cynocephalus", "anc.cynocephalus"), edge("anc.cynocephalus", "y"), 
  edge("P.ursinus", "anc.ursinus"), 
  edge("P.hamadryas", "anc.hamadryas"), edge("anc.hamadryas", "z"),
  edge("P.papio", "anc.papio"), edge("anc.papio", "z"),
  admixture_edge("anc.anubis2", "anc.hamadryas", "anc.papio"),
  admixture_edge("anc.anubis1", "anc.cynocephalus", "anc.anubis2"),
  edge("P.anubis", "anc.anubis1")
))
admixtures <- admixture_proportions(c(
  admix_props("anc.kindae", "anc.ursinus", "w", "a"),
  admix_props("anc.anubis2", "anc.hamadryas", "anc.papio", "b"),
  admix_props("anc.anubis1", "anc.cynocephalus", "anc.anubis2", "c")
))

kindae_admixed_graph_u3_anubis_papio_hamadryas_cynocephalus <- agraph(leaves, inner_nodes, edges, admixtures)
plot(kindae_admixed_graph_u3_anubis_papio_hamadryas_cynocephalus, show_admixture_labels = TRUE, main = "Cynocephalus, hamadryas and papio dmixed anubis")
```

```{r, echo=FALSE, fig.height=20}
posf4 %>% filter_on_leaves(kindae_admixed_graph_u3_anubis_papio_hamadryas_cynocephalus) %>%
  fit_graph(kindae_admixed_graph_u3_anubis_papio_hamadryas_cynocephalus) -> fit_kindae_admixed_graph_u3_anubis_papio_hamadryas_cynocephalus
```

Fitting this graph gives us an SSE of `r round(fit_kindae_admixed_graph_u3_anubis_papio_hamadryas_cynocephalus$error, 3)` and `r n_poor_fit(fit_kindae_admixed_graph_u3_anubis_papio_hamadryas_cynocephalus, 6)`.

```{r, echo=FALSE, fig.height=25}
fit_kindae_admixed_graph_u3_anubis_papio_hamadryas_cynocephalus %>% split_population %>% plot(sigma=6)
```
